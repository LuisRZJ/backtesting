<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="stylesheet" href="estilos.css?v=1.0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backtesting - Inicio</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="Logo_app_trading-removebg-preview.png">
    <link rel="icon" type="image/png" sizes="512x512" href="Logo_app_trading-removebg-preview.png">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>

<body>
    <button class="menu-toggle" onclick="toggleMenu()">☰</button>
    <div class="menu-overlay"></div>
    <nav class="nav-menu">
        <div class="menu-items">
            <a href="index.html" class="active">Inicio</a>
            <a href="registrar-trade.html">Registrar Trade</a>
            <a href="diario.html">Diario</a>
            <a href="estadisticas.html">Estadísticas</a>
            <a href="plan-trading.html">Plan de Trading</a>
            <a href="almacenamiento.html">Almacenamiento</a>
            <a href="ajustes.html">Ajustes</a>
            <a href="deposito-retiro.html">Deposito/Retiro</a>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1>Backtesting Trading</h1>
            <div id="datetime" class="datetime"></div>
        </div>

        <!-- Nueva tarjeta de Saldo Final -->
        <div class="main-balance-card">
            <h3>Saldo Final de la Cuenta</h3>
            <div class="final-balance">
                <span id="final-account-balance">$0.00</span>
            </div>
        </div>

        <div class="capital-evolution-card modern-card">
            <div class="capital-header">
                <h2 id="welcome-message">Hola, Usuario</h2>
                <div class="capital-balance" id="capital-balance">$0.00</div>
                <span id="capital-roi"></span>
            </div>
            <div class="period-filters integrated">
                <button class="period-filter" data-period="weekly">Semanal</button>
                <button class="period-filter active" data-period="monthly">Mensual</button>
                <button class="period-filter" data-period="yearly">Anual</button>
            </div>
            <!-- Mensaje de ayuda para calcular ROI -->
            <div class="roi-calculation-hint">
                <button class="collapsible-header">Ayuda para calcular ROI <span class="icon">▼</span></button>
                <div class="collapsible-content">
                    <p>
                        Para calcular el porcentaje de crecimiento (ROI) de tu cuenta para un periodo específico, necesitas dos datos clave para la <a href="calculadora-roi.html" class="roi-calculator-link">Calculadora de ROI</a>:
                        <br><br>
                        <strong>Cantidad A (Saldo al Inicio del Periodo):</strong> Puedes obtener este valor restando el 'PNL del periodo', al 'Saldo Final de la Cuenta'.
                        <br>
                        <strong>Cantidad B (Saldo al Final del Periodo):</strong> Este es el 'Saldo Final de la Cuenta' que aparece en la tarjeta principal.
                        <br><br>
                        Introduce la Cantidad A y la Cantidad B en la calculadora y obtendrás automáticamente tu porcentaje de crecimiento (ROI).
                    </p>
                </div>
            </div>
        </div>

        <div class="cards-container">
            <div class="card">
                <h3>Meta <span id="goal-period-text">Mensual</span></h3>
                <div class="goal-progress">
                    <div class="amounts-container">
                        <span class="current-amount" id="current-amount">$0.00</span>
                        <span class="separator">/</span>
                        <span class="goal-amount" id="goal-amount">$0.00</span>
                    </div>
                    <div class="progress-percentage" id="progress-percentage">0%</div>
                </div>
            </div>
        </div>

        <div class="summaries-container">
            <div class="daily-summary">
                <h2>Resumen Diario</h2>
                <div class="summary-stats">
                    <div class="stat-item">
                        <span class="stat-label">Operaciones Ganadas:</span>
                        <span id="winning-trades" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Operaciones Perdidas:</span>
                        <span id="losing-trades" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Empates:</span>
                        <span id="breakeven-trades" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">PNL:</span>
                        <span id="daily-pnl" class="stat-value">$0.00</span>
                    </div>
                </div>
            </div>

            <div class="daily-summary weekly-summary">
                <h2>Resumen Semanal</h2>
                <div class="summary-stats">
                    <div class="stat-item">
                        <span class="stat-label">Operaciones Ganadas:</span>
                        <span id="weekly-winning-trades" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Operaciones Perdidas:</span>
                        <span id="weekly-losing-trades" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Empates:</span>
                        <span id="weekly-breakeven-trades" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">PNL:</span>
                        <span id="weekly-pnl" class="stat-value">$0.00</span>
                    </div>
                </div>
            </div>

            <div class="daily-summary monthly-summary">
                <h2>Resumen Mensual</h2>
                <div class="summary-stats">
                    <div class="stat-item">
                        <span class="stat-label">Operaciones Ganadas:</span>
                        <span id="monthly-winning-trades" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Operaciones Perdidas:</span>
                        <span id="monthly-losing-trades" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Empates:</span>
                        <span id="monthly-breakeven-trades" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">PNL:</span>
                        <span id="monthly-pnl" class="stat-value">$0.00</span>
                    </div>
                </div>
            </div>

            <div class="daily-summary annual-summary">
                <h2>Resumen Anual</h2>
                <div class="summary-stats">
                    <div class="stat-item">
                        <span class="stat-label">Operaciones Ganadas:</span>
                        <span id="annual-winning-trades" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Operaciones Perdidas:</span>
                        <span id="annual-losing-trades" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Empates:</span>
                        <span id="annual-breakeven-trades" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">PNL:</span>
                        <span id="annual-pnl" class="stat-value">$0.00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="javascript.js"></script>
    <script>
        // Función para obtener una cookie
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        // Actualizar fecha y hora
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('datetime').textContent = now.toLocaleDateString('es-ES', options);
        }
        
        // Actualizar cada segundo
        setInterval(updateDateTime, 1000);
        updateDateTime();

        // Cargar datos de las tarjetas
        function loadCardData() {
            const trades = JSON.parse(localStorage.getItem('trades')) || [];
            const movements = JSON.parse(localStorage.getItem('capitalMovements')) || []; // Cargar movimientos de capital
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Establecer inicio del día
            
            // Filtrar trades del día actual
            const tradesHoy = trades.filter(trade => {
                const tradeDate = new Date(trade.openTime);
                tradeDate.setHours(0, 0, 0, 0);
                return tradeDate.getTime() === today.getTime();
            });
            
            // Calcular estadísticas del resumen diario
            const winningTrades = tradesHoy.filter(trade => parseFloat(trade.resultMxn) > 0).length;
            const losingTrades = tradesHoy.filter(trade => parseFloat(trade.resultMxn) < 0).length;
            const breakevenTrades = tradesHoy.filter(trade => parseFloat(trade.resultMxn) === 0).length;
            const dailyPnl = tradesHoy.reduce((sum, trade) => sum + parseFloat(trade.resultMxn), 0);

            // Actualizar el resumen diario
            document.getElementById('winning-trades').textContent = winningTrades;
            document.getElementById('losing-trades').textContent = losingTrades;
            document.getElementById('breakeven-trades').textContent = breakevenTrades;
            
            const dailyPnlElement = document.getElementById('daily-pnl');
            dailyPnlElement.textContent = `$${dailyPnl.toFixed(2)}`;
            dailyPnlElement.style.color = dailyPnl >= 0 ? '#2ecc71' : '#e74c3c';

            // Calcular estadísticas semanales
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay()); // Inicio de la semana (domingo)
            startOfWeek.setHours(0, 0, 0, 0);

            const tradesSemana = trades.filter(trade => {
                const tradeDate = new Date(trade.openTime);
                tradeDate.setHours(0, 0, 0, 0);
                return tradeDate >= startOfWeek && tradeDate <= today;
            });

            // Calcular estadísticas del resumen semanal
            const weeklyWinningTrades = tradesSemana.filter(trade => parseFloat(trade.resultMxn) > 0).length;
            const weeklyLosingTrades = tradesSemana.filter(trade => parseFloat(trade.resultMxn) < 0).length;
            const weeklyBreakevenTrades = tradesSemana.filter(trade => parseFloat(trade.resultMxn) === 0).length;
            const weeklyPnl = tradesSemana.reduce((sum, trade) => sum + parseFloat(trade.resultMxn), 0);

            // Actualizar el resumen semanal
            document.getElementById('weekly-winning-trades').textContent = weeklyWinningTrades;
            document.getElementById('weekly-losing-trades').textContent = weeklyLosingTrades;
            document.getElementById('weekly-breakeven-trades').textContent = weeklyBreakevenTrades;
            
            const weeklyPnlElement = document.getElementById('weekly-pnl');
            weeklyPnlElement.textContent = `$${weeklyPnl.toFixed(2)}`;
            weeklyPnlElement.style.color = weeklyPnl >= 0 ? '#2ecc71' : '#e74c3c';

            // Calcular estadísticas mensuales
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            startOfMonth.setHours(0, 0, 0, 0);

            const tradesMes = trades.filter(trade => {
                const tradeDate = new Date(trade.openTime);
                tradeDate.setHours(0, 0, 0, 0);
                return tradeDate >= startOfMonth && tradeDate <= today;
            });

            // Calcular estadísticas del resumen mensual
            const monthlyWinningTrades = tradesMes.filter(trade => parseFloat(trade.resultMxn) > 0).length;
            const monthlyLosingTrades = tradesMes.filter(trade => parseFloat(trade.resultMxn) < 0).length;
            const monthlyBreakevenTrades = tradesMes.filter(trade => parseFloat(trade.resultMxn) === 0).length;
            const monthlyPnl = tradesMes.reduce((sum, trade) => sum + parseFloat(trade.resultMxn), 0);

            // Actualizar el resumen mensual
            document.getElementById('monthly-winning-trades').textContent = monthlyWinningTrades;
            document.getElementById('monthly-losing-trades').textContent = monthlyLosingTrades;
            document.getElementById('monthly-breakeven-trades').textContent = monthlyBreakevenTrades;
            
            const monthlyPnlElement = document.getElementById('monthly-pnl');
            monthlyPnlElement.textContent = `$${monthlyPnl.toFixed(2)}`;
            monthlyPnlElement.style.color = monthlyPnl >= 0 ? '#2ecc71' : '#e74c3c';

            // Calcular estadísticas anuales
            const startOfYear = new Date(today.getFullYear(), 0, 1);
            startOfYear.setHours(0, 0, 0, 0);

            const tradesAnio = trades.filter(trade => {
                const tradeDate = new Date(trade.openTime);
                tradeDate.setHours(0, 0, 0, 0);
                return tradeDate >= startOfYear && tradeDate <= today;
            });

            // Calcular estadísticas del resumen anual
            const annualWinningTrades = tradesAnio.filter(trade => parseFloat(trade.resultMxn) > 0).length;
            const annualLosingTrades = tradesAnio.filter(trade => parseFloat(trade.resultMxn) < 0).length;
            const annualBreakevenTrades = tradesAnio.filter(trade => parseFloat(trade.resultMxn) === 0).length;
            const annualPnl = tradesAnio.reduce((sum, trade) => sum + parseFloat(trade.resultMxn), 0);

            // Actualizar el resumen anual
            document.getElementById('annual-winning-trades').textContent = annualWinningTrades;
            document.getElementById('annual-losing-trades').textContent = annualLosingTrades;
            document.getElementById('annual-breakeven-trades').textContent = annualBreakevenTrades;
            const annualPnlElement = document.getElementById('annual-pnl');
            annualPnlElement.textContent = `$${annualPnl.toFixed(2)}`;
            annualPnlElement.style.color = annualPnl >= 0 ? '#2e7d32' : '#e74c3c';

            // Cargar meta y período desde cookies
            const monthlyGoal = getCookie('monthlyGoal') || '10000';
            const goalPeriod = getCookie('goalPeriod') || 'monthly';
            
            // Actualizar el texto del período
            const periodTexts = {
                'daily': 'Diaria',
                'weekly': 'Semanal',
                'monthly': 'Mensual',
                'yearly': 'Anual'
            };
            document.getElementById('goal-period-text').textContent = periodTexts[goalPeriod] || 'Mensual';
            
            // Calcular el PNL para el período seleccionado
            let periodStart;
            switch(goalPeriod) {
                case 'daily':
                    periodStart = new Date(today.setHours(0, 0, 0, 0));
                    break;
                case 'weekly':
                    periodStart = new Date(today.setDate(today.getDate() - today.getDay()));
                    break;
                case 'monthly':
                    periodStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    break;
                case 'yearly':
                    periodStart = new Date(today.getFullYear(), 0, 1);
                    break;
                default:
                    periodStart = new Date(today.getFullYear(), today.getMonth(), 1);
            }

            const periodPNL = trades
                .filter(trade => new Date(trade.openTime) >= periodStart)
                .reduce((sum, trade) => sum + parseFloat(trade.resultMxn), 0);

            // Actualizar la visualización del progreso
            const goalAmount = parseFloat(monthlyGoal);
            const progressPercentage = (periodPNL / goalAmount) * 100;
            
            // Actualizar elementos con los valores calculados
            const currentAmountElement = document.getElementById('current-amount');
            const goalAmountElement = document.getElementById('goal-amount');
            const progressElement = document.getElementById('progress-percentage');

            currentAmountElement.textContent = `$${periodPNL.toFixed(2)}`;
            goalAmountElement.textContent = `$${goalAmount.toFixed(2)}`;
            progressElement.textContent = `${progressPercentage.toFixed(1)}%`;

            // Aplicar colores según el progreso
            currentAmountElement.style.color = periodPNL >= goalAmount ? '#2e7d32' : '#f57c00';
            currentAmountElement.style.fontWeight = 'bold';
            goalAmountElement.style.color = '#2e7d32';
            progressElement.style.color = '#FF6B00';

            // --- Calcular y mostrar Saldo Final --- //
            const initialCapital = parseFloat(localStorage.getItem('initialCapital')) || 0; // Obtener capital inicial, default 0 si no existe
            const totalMovementsPnl = movements.reduce((sum, movement) => {
                if (movement.type === 'deposito') {
                    return sum + parseFloat(movement.amount);
                } else if (movement.type === 'retiro') {
                    return sum - parseFloat(movement.amount);
                }
                return sum;
            }, 0);

            // Calcular el PNL total de las operaciones de trading
            const totalTradesPnl = trades.reduce((sum, trade) => sum + parseFloat(trade.resultMxn), 0);

            // Calcular el saldo final sumando el capital inicial, el PNL de movimientos y el PNL de trades
            const finalBalance = initialCapital + totalMovementsPnl + totalTradesPnl;

            const finalBalanceElement = document.getElementById('final-account-balance');
            if (finalBalanceElement) {
                finalBalanceElement.textContent = `$${finalBalance.toFixed(2)}`;
                // Aplicar color basado en si el saldo ha crecido desde el capital inicial
                finalBalanceElement.style.color = finalBalance >= initialCapital ? '#2e7d32' : '#e74c3c';
            }
            // ------------------------------------ //
        }

        // Cargar tema guardado
        function loadTheme() {
            const theme = getCookie('theme') || 'light';
            document.body.className = theme;
        }

        // Funciones para el menú de navegación
        const navMenu = document.querySelector('.nav-menu');
        const menuToggle = document.querySelector('.menu-toggle');
        const menuOverlay = document.querySelector('.menu-overlay');
        let scrollPosition = 0;

        function toggleMenu() {
            const isVisible = navMenu.classList.contains('visible');
            
            if (!isVisible) {
                // Guardar posición del scroll
                scrollPosition = window.pageYOffset;
                // Bloquear scroll
                document.body.classList.add('menu-open');
                document.body.style.top = `-${scrollPosition}px`;
                // Mostrar overlay
                menuOverlay.classList.add('visible');
            } else {
                // Restaurar scroll
                document.body.classList.remove('menu-open');
                document.body.style.top = '';
                window.scrollTo(0, scrollPosition);
                // Ocultar overlay
                menuOverlay.classList.remove('visible');
            }
            
            navMenu.classList.toggle('visible');
        }

        // Cerrar menú al hacer clic en un enlace
        document.querySelectorAll('.menu-items a').forEach(link => {
            link.addEventListener('click', () => {
                // Solo navegar a la nueva página, no cerrar el menú
                // El menú se cerrará automáticamente al cargar la nueva página
            });
        });

        // Marcar enlace activo según la página actual
        function setActiveLink() {
            const currentPage = window.location.pathname.split('/').pop() || 'index.html';
            const links = document.querySelectorAll('.menu-items a');
            
            links.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === currentPage) {
                    link.classList.add('active');
                }
            });
        }

        // Cargar datos al iniciar
        loadTheme();
        loadCardData();
        setActiveLink();
    </script>
</body>
</html>
